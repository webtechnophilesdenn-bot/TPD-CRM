<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\CaseStudy;
use App\Models\CaseStudyCategory;
use App\Models\CaseStudyTechnology;
use App\Models\CaseStudyTimeline;
use App\Models\CaseStudyMetric;
use Illuminate\Support\Str;

class CaseStudySeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // First, seed categories
        $this->seedCategories();
        
        // Then seed case studies with their relationships
        $this->seedCaseStudies();
    }

    /**
     * Seed case study categories
     */
    private function seedCategories(): void
    {
        $categories = [
            ['name' => 'cloud', 'slug' => 'cloud', 'icon' => 'fas fa-cloud', 'display_order' => 1],
            ['name' => 'security', 'slug' => 'security', 'icon' => 'fas fa-shield-alt', 'display_order' => 2],
            ['name' => 'devops', 'slug' => 'devops', 'icon' => 'fas fa-cogs', 'display_order' => 3],
            ['name' => 'infrastructure', 'slug' => 'infrastructure', 'icon' => 'fas fa-server', 'display_order' => 4],
            ['name' => 'consulting', 'slug' => 'consulting', 'icon' => 'fas fa-handshake', 'display_order' => 5],
            ['name' => 'ai', 'slug' => 'ai', 'icon' => 'fas fa-brain', 'display_order' => 6],
            ['name' => 'data', 'slug' => 'data', 'icon' => 'fas fa-chart-bar', 'display_order' => 7],
            ['name' => 'migration', 'slug' => 'migration', 'icon' => 'fas fa-exchange-alt', 'display_order' => 8],
        ];

        foreach ($categories as $category) {
            CaseStudyCategory::firstOrCreate(
                ['slug' => $category['slug']],
                $category
            );
        }
    }

    /**
     * Seed all case studies
     */
    private function seedCaseStudies(): void
    {
        $caseStudies = $this->getCaseStudiesData();

        foreach ($caseStudies as $index => $caseData) {
            // Create case study
            $caseStudy = CaseStudy::create([
                'title' => $caseData['title'],
                'description' => $caseData['description'],
                'image' => $caseData['image'],
                'search_keywords' => $caseData['searchKeywords'] ?? '',
                'challenge' => $caseData['challenge'] ?? null,
                'solution' => $caseData['solution'] ?? null,
                'results' => $caseData['results'] ?? null,
                'project_date' => now()->subMonths(rand(1, 24))->format('Y-m-d'),
                'status' => 'published',
                'is_featured' => $index < 5, // First 5 are featured
                'display_order' => $index + 1,
            ]);

            // Attach categories
            $categoryIds = [];
            foreach ($caseData['categories'] as $categoryName) {
                $category = CaseStudyCategory::where('slug', $categoryName)->first();
                if ($category) {
                    $categoryIds[] = $category->id;
                }
            }
            $caseStudy->categories()->sync($categoryIds);

            // Add technologies
            if (isset($caseData['technologies'])) {
                foreach ($caseData['technologies'] as $order => $tech) {
                    CaseStudyTechnology::create([
                        'case_study_id' => $caseStudy->id,
                        'name' => $tech['name'],
                        'icon' => $tech['icon'],
                        'display_order' => $order + 1,
                    ]);
                }
            }

            // Add timeline
            if (isset($caseData['timeline'])) {
                foreach ($caseData['timeline'] as $order => $timeline) {
                    CaseStudyTimeline::create([
                        'case_study_id' => $caseStudy->id,
                        'date' => $timeline['date'],
                        'title' => $timeline['title'],
                        'description' => $timeline['description'],
                        'display_order' => $order + 1,
                    ]);
                }
            }

            // Add metrics
            if (isset($caseData['metrics'])) {
                foreach ($caseData['metrics'] as $order => $metric) {
                    CaseStudyMetric::create([
                        'case_study_id' => $caseStudy->id,
                        'number' => $metric['number'],
                        'label' => $metric['label'],
                        'display_order' => $order + 1,
                    ]);
                }
            }
        }
    }

    /**
     * Get all case studies data
     */
    private function getCaseStudiesData(): array
    {
        return [
            // MULTI-CLOUD
            [
                'title' => 'Multi-Cloud Landing Zones for Global Enterprise',
                'description' => 'Designed AWS & Azure landing zones with unified guardrails, SSO, and network segmentation. Outcome: standardized provisioning, policy compliance, and 32% lower ops overhead.',
                'categories' => ['cloud', 'infrastructure', 'migration'],
                'image' => 'img/cases/mc-landing-zones.jpg',
                'searchKeywords' => 'multi cloud landing zone aws azure guardrails sso network segmentation compliance automation',
            ],
            [
                'title' => 'Hybrid to Multi-Cloud Migration Without Downtime',
                'description' => 'Phased migration from on-prem to AWS & GCP using blue/green cutovers, Cloud SQL/RDS, and global DNS. Zero outage; 40% latency reduction for APAC users.',
                'categories' => ['cloud', 'infrastructure', 'migration'],
                'image' => 'img/cases/mc-hybrid-migration.jpg',
                'searchKeywords' => 'hybrid migration aws gcp blue green cutover rds cloud sql global dns latency reduction',
            ],
            [
                'title' => 'Cloud Cost Governance With FinOps',
                'description' => 'Introduced FinOps across multi-cloud estate—budgets, tag hygiene, RI/SP planning. Cloud spend down 28% within 90 days.',
                'categories' => ['cloud', 'consulting'],
                'image' => 'img/cases/mc-finops.webp',
                'searchKeywords' => 'finops cost optimization budgets tagging savings plans ri cloud governance visibility',
            ],

            // SOFTWARE
            [
                'title' => 'Greenfield B2B Platform — 12-Week MVP',
                'description' => 'TypeScript/NestJS + React, monorepo, feature flags, GitHub Actions CI/CD. Delivered MVP in 12 weeks.',
                'categories' => ['consulting', 'devops'],
                'image' => 'img/cases/sw-mvp.jpg',
                'searchKeywords' => 'software development mvp typescript react nestjs monorepo feature flags ci cd github actions',
            ],
            [
                'title' => 'Legacy .NET App Modernized to REST + Events',
                'description' => 'Extracted core domains, REST APIs and Kafka event streams. Releases moved from quarterly to weekly.',
                'categories' => ['consulting', 'infrastructure', 'devops'],
                'image' => 'img/cases/sw-modernize.jpg',
                'searchKeywords' => 'legacy modernization dotnet rest api event driven kafka domain extraction weekly releases',
            ],

            // MOBILE
            [
                'title' => 'Consumer Super-App With Offline-First',
                'description' => 'React Native app with offline queueing and OTA updates. Crash-free sessions >99.7%.',
                'categories' => ['consulting'],
                'image' => 'img/cases/mobile-offline.jpg',
                'searchKeywords' => 'mobile app react native offline first ota updates feature flags analytics crash free',
            ],
            [
                'title' => 'Secure Mobile Banking on Cloud Backends',
                'description' => 'Zero-trust APIs, device attestation, KMS encryption. Achieved PCI DSS & SOC2 controls.',
                'categories' => ['security', 'cloud', 'consulting'],
                'image' => 'img/cases/mobile-banking.jpg',
                'searchKeywords' => 'mobile banking security zero trust kms encryption device attestation pci soc2',
            ],

            // BLOCKCHAIN
            [
                'title' => 'Supply-Chain Traceability on Blockchain',
                'description' => 'Ethereum sidechain for product provenance + IPFS docs. Disputes reduced by 60%.',
                'categories' => ['consulting', 'security'],
                'image' => 'img/cases/bc-traceability.jpg',
                'searchKeywords' => 'blockchain supply chain provenance ethereum sidechain ipfs smart contracts audit',
            ],
            [
                'title' => 'Tokenized Loyalty With Smart Contracts',
                'description' => 'ERC-20/721 contracts and custodial wallet flows. Partner onboarding cut from weeks to days.',
                'categories' => ['consulting'],
                'image' => 'img/cases/bc-loyalty.jpg',
                'searchKeywords' => 'token loyalty erc20 erc721 smart contract wallet onboarding gas optimization',
            ],

            // STAFF AUG
            [
                'title' => 'Cloud Center of Excellence — Staff Pods',
                'description' => 'Augmented with SRE/DevOps/SecOps pods. MTTR improved 45%; deployment frequency up 3×.',
                'categories' => ['consulting', 'devops', 'security'],
                'image' => 'img/cases/sta-coe.jpg',
                'searchKeywords' => 'staff augmentation sre devops secops mttr deployment frequency cloud center excellence',
            ],
            [
                'title' => 'Data Engineering Augmentation for Analytics',
                'description' => 'DE squad delivered ELT on Spark + Airflow. 30+ self-serve dashboards in 6 weeks.',
                'categories' => ['consulting', 'data'],
                'image' => 'img/cases/sta-data-eng.jpg',
                'searchKeywords' => 'staff augmentation data engineering spark airflow elt self serve bi dashboards',
            ],

            // SECURITY
            [
                'title' => 'Zero-Trust Architecture Across Clouds',
                'description' => 'Identity-aware proxies, micro-segmentation, JIT access. Phishing impact down 70%.',
                'categories' => ['security', 'cloud', 'infrastructure'],
                'image' => 'img/cases/sec-zero-trust.jpg',
                'searchKeywords' => 'zero trust iam proxy micro segmentation jit access phishing mfa conditional access',
            ],
            [
                'title' => 'Cloud Security Posture Management (CSPM)',
                'description' => 'CSPM + IaC scanning with drift detection & auto-remediation. 400+ misconfigs fixed in month one.',
                'categories' => ['security', 'cloud'],
                'image' => 'img/cases/sec-cspm.jpg',
                'searchKeywords' => 'cspm iac scanning drift detection remediation misconfig security posture guardrails',
            ],

            // DATA SCIENCE
            [
                'title' => 'Demand Forecasting for Retail',
                'description' => 'Probabilistic forecasts (Prophet + XGBoost) with promo features. +18% accuracy.',
                'categories' => ['data', 'ai'],
                'image' => 'img/cases/ds-forecast.jpg',
                'searchKeywords' => 'data science forecasting retail prophet xgboost promotions holidays accuracy improvement',
            ],
            [
                'title' => 'Churn Prediction With Explainability',
                'description' => 'Churn model with SHAP & action playbooks — 12% churn reduction.',
                'categories' => ['data', 'ai', 'consulting'],
                'image' => 'img/cases/ds-churn.jpg',
                'searchKeywords' => 'churn prediction shap explainable ai uplift retention playbooks',
            ],

            // AI/ML
            [
                'title' => 'GenAI Customer Support Copilot',
                'description' => 'RAG on private docs with guardrails & PII redaction. AHT reduced 37%.',
                'categories' => ['ai', 'cloud'],
                'image' => 'img/cases/ai-copilot.jpg',
                'searchKeywords' => 'genai rag vector search pii redaction guardrails customer support aht reduction',
            ],
            [
                'title' => 'Vision Model for Quality Inspection',
                'description' => 'Edge-deployed defect detection (YOLOv8) with active learning. False rejects down 42%.',
                'categories' => ['ai', 'infrastructure'],
                'image' => 'img/cases/ai-vision.jpg',
                'searchKeywords' => 'computer vision yolo quality inspection edge ai active learning manufacturing',
            ],

            // DEVOPS
            [
                'title' => 'Kubernetes Platform With GitOps',
                'description' => 'EKS + ArgoCD GitOps, multi-tenant namespaces, OPA. Lead time dropped 60%.',
                'categories' => ['devops', 'cloud', 'infrastructure'],
                'image' => 'img/cases/devops-gitops.jpg',
                'searchKeywords' => 'kubernetes eks gitops argocd opa multi tenant lead time dora metrics',
            ],
            [
                'title' => 'Golden Path CI/CD Templates',
                'description' => 'Reusable pipelines (Node/Java/.NET) with SAST/DAST, SBOM, preview envs. Onboarding time → hours.',
                'categories' => ['devops', 'security'],
                'image' => 'img/cases/devops-golden-path.jpg',
                'searchKeywords' => 'cicd templates sbom sast dast preview environments onboarding developer experience',
            ],

            // REMOTE INFRA
            [
                'title' => '24×7 SRE for Payments Platform',
                'description' => 'SLOs, error budgets & auto-healing runbooks. Availability sustained at 99.97%.',
                'categories' => ['infrastructure', 'devops', 'cloud'],
                'image' => 'img/cases/ri-sre.jpg',
                'searchKeywords' => 'sre slo error budget runbooks auto healing incident management payments',
            ],
            [
                'title' => 'Observability Modernization',
                'description' => 'OpenTelemetry → Grafana stack, exemplars & log sampling. MTTD improved 55%.',
                'categories' => ['infrastructure', 'devops'],
                'image' => 'img/cases/ri-observability.jpg',
                'searchKeywords' => 'observability opentelemetry grafana traces logs metrics exemplars mttd mttr',
            ],

            // ENHANCED CLOUD WITH FULL DETAILS
            [
                'title' => 'AWS Cloud Migration: AdvisoryCloud Modernizes Monolith',
                'description' => 'Landing zone, network segmentation, containerized workloads, and automated CI/CD. 45% faster deployments, 30% cost reduction, >99.9% availability.',
                'categories' => ['cloud', 'infrastructure', 'migration'],
                'image' => 'img/img01_AdvisoryCloud_AWS_Migration.jpg',
                'searchKeywords' => 'aws cloud migration modernization monolith microservices eks rds autoscaling cost optimization finops devops ci cd',
                'challenge' => 'Legacy monolith couldn\'t scale; frequent downtime and high maintenance distracted engineering from feature work.',
                'solution' => 'Break monolith into microservices on EKS; implement CI/CD, autoscaling, observability and a secure landing zone.',
                'results' => '>99.9% uptime, 45% faster deployments, and ~30% cost reduction via rightsizing & autoscaling.',
                'technologies' => [
                    ['name' => 'AWS EKS', 'icon' => 'fas fa-dharmachakra'],
                    ['name' => 'RDS', 'icon' => 'fas fa-database'],
                    ['name' => 'S3', 'icon' => 'fab fa-aws'],
                    ['name' => 'ALB', 'icon' => 'fas fa-project-diagram'],
                    ['name' => 'Terraform', 'icon' => 'fas fa-code-branch'],
                    ['name' => 'CloudWatch', 'icon' => 'fas fa-chart-line'],
                ],
                'timeline' => [
                    ['date' => 'W1–2', 'title' => 'Assessment & Plan', 'description' => 'Architecture review and migration roadmap.'],
                    ['date' => 'W3–6', 'title' => 'Platform Build', 'description' => 'Landing zone, networking, security baselines.'],
                    ['date' => 'W7–10', 'title' => 'Workload Migration', 'description' => 'Blue/green cutovers with zero downtime.'],
                    ['date' => 'W11–12', 'title' => 'Hardening', 'description' => 'Perf tuning, training, and handover.'],
                ],
                'metrics' => [
                    ['number' => '>99.9%', 'label' => 'Availability'],
                    ['number' => '45%', 'label' => 'Faster Deploys'],
                    ['number' => '30%', 'label' => 'Cost Reduction'],
                    ['number' => '0', 'label' => 'Downtime during cutover'],
                ],
            ],
            [
                'title' => 'ACR: Secure & Scalable Data Lake on AWS',
                'description' => 'Three-layer data lake with governed ingestion and secure integrations across sources.',
                'categories' => ['cloud', 'data', 'security'],
                'image' => 'img/img10_ACR_Data_Lake.jpg',
                'searchKeywords' => 'data lake aws medallion bronze silver gold governance glue lake formation security',
                'challenge' => 'Disparate data sources, inconsistent governance, and limited analytics velocity.',
                'solution' => 'Medallion architecture (Bronze/Silver/Gold) with Lake Formation, Glue ETL, and centralized IAM/KMS.',
                'results' => 'Secure, query-ready datasets; faster analytics delivery; consistent governance for all producers/consumers.',
                'technologies' => [
                    ['name' => 'S3', 'icon' => 'fab fa-aws'],
                    ['name' => 'Athena', 'icon' => 'fas fa-magnifying-glass'],
                    ['name' => 'Glue', 'icon' => 'fas fa-diagram-project'],
                    ['name' => 'Lake Formation', 'icon' => 'fas fa-shield-halved'],
                    ['name' => 'KMS', 'icon' => 'fas fa-key'],
                ],
                'timeline' => [
                    ['date' => 'M1', 'title' => 'Foundation', 'description' => 'Landing zone & guardrails; catalog strategy.'],
                    ['date' => 'M2–3', 'title' => 'Ingestion', 'description' => 'Pipelines & schema evolution.'],
                    ['date' => 'M4', 'title' => 'Governance', 'description' => 'Row/column-level permissions; auditing.'],
                ],
                'metrics' => [
                    ['number' => '3-layer', 'label' => 'Medallion'],
                    ['number' => 'RBAC', 'label' => 'Fine-grained access'],
                    ['number' => '↓', 'label' => 'Time-to-insight'],
                ],
            ],
            [
                'title' => 'ADCO: Secure Remote File Access on AWS',
                'description' => 'AWS Storage Gateway + S3 with VPN & MFA for secure, fast remote file access.',
                'categories' => ['security', 'cloud'],
                'image' => 'img/img03_ADCO_Secure_File_Access.jpg',
                'searchKeywords' => 'secure file access storage gateway s3 vpn mfa kms encryption',
                'challenge' => 'Remote teams needed fast access to large files; legacy solution was slow and risky.',
                'solution' => 'Deployed Storage Gateway backed by S3; enforced MFA, encryption in transit/at rest, and RBAC.',
                'results' => '70% faster access times, zero security incidents, and virtually unlimited storage durability.',
                'technologies' => [
                    ['name' => 'Storage Gateway', 'icon' => 'fas fa-hdd'],
                    ['name' => 'Amazon S3', 'icon' => 'fab fa-aws'],
                    ['name' => 'AWS IAM', 'icon' => 'fas fa-users-cog'],
                    ['name' => 'VPN', 'icon' => 'fas fa-shield-alt'],
                    ['name' => 'KMS', 'icon' => 'fas fa-key'],
                    ['name' => 'CloudTrail', 'icon' => 'fas fa-search'],
                ],
                'timeline' => [
                    ['date' => 'W1', 'title' => 'Security Assessment', 'description' => 'Threat modeling & access review.'],
                    ['date' => 'W2–3', 'title' => 'Build', 'description' => 'Gateway deploy, policies, automation.'],
                    ['date' => 'W4', 'title' => 'UAT & Training', 'description' => 'User testing + handover.'],
                ],
                'metrics' => [
                    ['number' => '70%', 'label' => 'Faster Access'],
                    ['number' => '0', 'label' => 'Incidents'],
                    ['number' => '11x9s', 'label' => 'Durability'],
                ],
            ],
            [
                'title' => 'Zero-Downtime DB Modernization (Oracle → Aurora PostgreSQL)',
                'description' => 'Used DMS + CDC with dual-write cutover. License cost −47%, query latency −35%.',
                'categories' => ['cloud', 'infrastructure', 'data'],
                'image' => 'img/cases/cloud-db-modernization.jpg',
                'searchKeywords' => 'database migration oracle aurora postgresql dms cdc zero downtime cost reduction latency',
            ],
        ];
    }
}