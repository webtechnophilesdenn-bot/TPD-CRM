name: Deploy to Server

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH smoke test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            echo "SSH OK"
            whoami
            hostname
            test -x /var/www/tpd-web/deploy.sh && echo "deploy.sh present" || (echo "deploy.sh missing" && exit 1)

      # ðŸ‘‰ NEW: make sure LFS content is present on the server
      - name: Update repo on server + Git LFS pull
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -e
            # install git-lfs if missing
            if ! command -v git-lfs >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y git-lfs
              sudo git lfs install --system
            fi

            cd /var/www/tpd-web

            # make sure we are on the latest commit of main
            git fetch origin main --tags
            git reset --hard origin/main
            git submodule update --init --recursive || true

            # pull LFS files
            git lfs install --local || true
            git lfs pull

            # quick sanity check for your video
            ls -lh public/img/banner_video.mp4 || true
            file public/img/banner_video.mp4 || true

      - name: Run deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            bash /var/www/tpd-web/deploy.sh
