<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Models\CaseStudy;
use App\Models\CaseStudyCategory;
use App\Models\CaseStudyTechnology;
use App\Models\CaseStudyTimeline;
use App\Models\CaseStudyMetric;
use Illuminate\Support\Facades\DB;

class ImportCaseStudiesCommand extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'casestudies:import 
                            {--fresh : Truncate existing data before import}
                            {--categories-only : Only import categories}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Import case studies data from predefined array into database';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('Starting case studies import...');

        if ($this->option('fresh')) {
            if (!$this->confirm('This will delete all existing case study data. Continue?')) {
                $this->info('Import cancelled.');
                return 0;
            }
            $this->truncateTables();
        }

        DB::beginTransaction();
        
        try {
            // Import categories first
            $this->info('Importing categories...');
            $this->importCategories();
            $this->info('✓ Categories imported successfully');

            if (!$this->option('categories-only')) {
                // Import case studies with all relationships
                $this->info('Importing case studies...');
                $imported = $this->importCaseStudies();
                $this->info("✓ Successfully imported {$imported} case studies");
            }

            DB::commit();
            $this->info('✓ Import completed successfully!');
            
            // Show summary
            $this->showSummary();
            
            return 0;
        } catch (\Exception $e) {
            DB::rollBack();
            $this->error('Import failed: ' . $e->getMessage());
            $this->error('Stack trace: ' . $e->getTraceAsString());
            return 1;
        }
    }

    /**
     * Truncate all case study related tables
     */
    private function truncateTables(): void
    {
        $this->warn('Truncating existing data...');
        
        DB::statement('SET FOREIGN_KEY_CHECKS=0');
        
        CaseStudyMetric::truncate();
        CaseStudyTimeline::truncate();
        CaseStudyTechnology::truncate();
        DB::table('case_study_category_pivot')->truncate();
        CaseStudy::truncate();
        CaseStudyCategory::truncate();
        
        DB::statement('SET FOREIGN_KEY_CHECKS=1');
        
        $this->info('✓ Tables truncated');
    }

    /**
     * Import categories
     */
    private function importCategories(): void
    {
        $categories = [
            ['name' => 'cloud', 'slug' => 'cloud', 'icon' => 'fas fa-cloud', 'display_order' => 1],
            ['name' => 'security', 'slug' => 'security', 'icon' => 'fas fa-shield-alt', 'display_order' => 2],
            ['name' => 'devops', 'slug' => 'devops', 'icon' => 'fas fa-cogs', 'display_order' => 3],
            ['name' => 'infrastructure', 'slug' => 'infrastructure', 'icon' => 'fas fa-server', 'display_order' => 4],
            ['name' => 'consulting', 'slug' => 'consulting', 'icon' => 'fas fa-handshake', 'display_order' => 5],
            ['name' => 'ai', 'slug' => 'ai', 'icon' => 'fas fa-brain', 'display_order' => 6],
            ['name' => 'data', 'slug' => 'data', 'icon' => 'fas fa-chart-bar', 'display_order' => 7],
            ['name' => 'migration', 'slug' => 'migration', 'icon' => 'fas fa-exchange-alt', 'display_order' => 8],
        ];

        $bar = $this->output->createProgressBar(count($categories));
        $bar->start();

        foreach ($categories as $category) {
            CaseStudyCategory::updateOrCreate(
                ['slug' => $category['slug']],
                $category
            );
            $bar->advance();
        }

        $bar->finish();
        $this->newLine();
    }

    /**
     * Import all case studies
     */
    private function importCaseStudies(): int
    {
        $caseStudiesData = $this->getCaseStudiesData();
        
        $bar = $this->output->createProgressBar(count($caseStudiesData));
        $bar->start();

        $imported = 0;

        foreach ($caseStudiesData as $index => $data) {
            try {
                // Create case study
                $caseStudy = CaseStudy::create([
                    'title' => $data['title'],
                    'description' => $data['description'],
                    'image' => $data['image'],
                    'search_keywords' => $data['searchKeywords'] ?? '',
                    'challenge' => $data['challenge'] ?? null,
                    'solution' => $data['solution'] ?? null,
                    'results' => $data['results'] ?? null,
                    'project_date' => now()->subMonths(rand(1, 24))->format('Y-m-d'),
                    'status' => 'published',
                    'is_featured' => $index < 5,
                    'display_order' => $index + 1,
                ]);

                // Attach categories
                $categoryIds = [];
                foreach ($data['categories'] as $categorySlug) {
                    $category = CaseStudyCategory::where('slug', $categorySlug)->first();
                    if ($category) {
                        $categoryIds[] = $category->id;
                    }
                }
                if (!empty($categoryIds)) {
                    $caseStudy->categories()->sync($categoryIds);
                }

                // Add technologies
                if (isset($data['technologies'])) {
                    foreach ($data['technologies'] as $order => $tech) {
                        CaseStudyTechnology::create([
                            'case_study_id' => $caseStudy->id,
                            'name' => $tech['name'],
                            'icon' => $tech['icon'],
                            'display_order' => $order + 1,
                        ]);
                    }
                }

                // Add timeline
                if (isset($data['timeline'])) {
                    foreach ($data['timeline'] as $order => $timeline) {
                        CaseStudyTimeline::create([
                            'case_study_id' => $caseStudy->id,
                            'date' => $timeline['date'],
                            'title' => $timeline['title'],
                            'description' => $timeline['description'],
                            'display_order' => $order + 1,
                        ]);
                    }
                }

                // Add metrics
                if (isset($data['metrics'])) {
                    foreach ($data['metrics'] as $order => $metric) {
                        CaseStudyMetric::create([
                            'case_study_id' => $caseStudy->id,
                            'number' => $metric['number'],
                            'label' => $metric['label'],
                            'display_order' => $order + 1,
                        ]);
                    }
                }

                $imported++;
            } catch (\Exception $e) {
                $this->error("\nError importing case study '{$data['title']}': " . $e->getMessage());
            }

            $bar->advance();
        }

        $bar->finish();
        $this->newLine();

        return $imported;
    }

    /**
     * Show import summary
     */
    private function showSummary(): void
    {
        $this->newLine();
        $this->info('=== Import Summary ===');
        $this->table(
            ['Model', 'Count'],
            [
                ['Categories', CaseStudyCategory::count()],
                ['Case Studies', CaseStudy::count()],
                ['Technologies', CaseStudyTechnology::count()],
                ['Timeline Items', CaseStudyTimeline::count()],
                ['Metrics', CaseStudyMetric::count()],
            ]
        );
    }

    /**
     * Get all case studies data
     * This is the same data from your HTML file
     */
    private function getCaseStudiesData(): array
    {
        // Same array as in the seeder - including all 25 case studies
        return [
            [
                'title' => 'Multi-Cloud Landing Zones for Global Enterprise',
                'description' => 'Designed AWS & Azure landing zones with unified guardrails, SSO, and network segmentation. Outcome: standardized provisioning, policy compliance, and 32% lower ops overhead.',
                'categories' => ['cloud', 'infrastructure', 'migration'],
                'image' => 'img/cases/mc-landing-zones.jpg',
                'searchKeywords' => 'multi cloud landing zone aws azure guardrails sso network segmentation compliance automation',
            ],
            // ... include all other case studies from the seeder
            // (abbreviated for length - include all 25 from the seeder)
        ];
    }
}