<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class SeoMiddleware
{
    public function handle(Request $request, Closure $next)
    {
        $response = $next($request);
        
        // Only process HTML
        if (!$this->isHtmlResponse($response)) {
            return $response;
        }
        
        $content = $response->getContent();
        
        // Fix canonical (one per page)
        $content = $this->fixCanonical($request, $content);
        
        // Fix meta description
        $content = $this->fixMetaDescription($content);
        
        // Fix images
        $content = $this->fixImages($content);
        
        $response->setContent($content);
        
        // Add headers
        return $this->addHeaders($response);
    }
    
    private function isHtmlResponse($response)
    {
        $contentType = $response->headers->get('Content-Type', '');
        return $contentType && Str::contains(strtolower($contentType), 'text/html');
    }
    
    private function fixCanonical(Request $request, $content)
    {
        $canonicalUrl = 'https://www.technophilesden.com' . $request->getPathInfo();
        
        // Remove all existing canonical tags
        $content = preg_replace('/<link[^>]*rel=["\']canonical["\'][^>]*>/i', '', $content);
        
        // Add single canonical tag
        $canonical = '<link rel="canonical" href="' . e($canonicalUrl) . '">';
        
        // Insert before closing head
        if (Str::contains($content, '</head>')) {
            $content = str_replace('</head>', "    {$canonical}\n</head>", $content);
        }
        
        return $content;
    }
    
    private function fixMetaDescription($content)
    {
        $newDescription = 'Technophiles Den - Expert DevOps, AI/ML & Cybersecurity solutions. Technology blog, tutorials, and enterprise solutions for modern businesses.';
        
        // Remove all meta descriptions
        $content = preg_replace('/<meta[^>]*name=["\']description["\'][^>]*>/i', '', $content);
        
        // Add one good meta description
        $meta = '<meta name="description" content="' . e($newDescription) . '">';
        
        if (Str::contains($content, '</head>')) {
            $content = str_replace('</head>', "    {$meta}\n</head>", $content);
        }
        
        return $content;
    }
    
    private function fixImages($content)
    {
        return preg_replace_callback(
            '/<img([^>]*)>/i',
            function ($matches) {
                $attrs = $matches[1];
                
                // Add alt if missing
                if (!preg_match('/alt=["\'][^"\']*["\']/i', $attrs)) {
                    // Try to extract from src
                    if (preg_match('/src=["\'][^"\']*([^\/"\']+)["\']/i', $attrs, $srcMatch)) {
                        $alt = str_replace(['-', '_', '.jpg', '.png', '.webp'], ' ', $srcMatch[1]);
                        $alt = ucwords(trim($alt));
                        $attrs .= ' alt="' . e($alt) . '"';
                    } else {
                        $attrs .= ' alt="Technophiles Den"';
                    }
                }
                
                // Add dimensions
                if (!preg_match('/width=["\'][^"\']*["\']/i', $attrs)) {
                    $attrs .= ' width="1200"';
                }
                if (!preg_match('/height=["\'][^"\']*["\']/i', $attrs)) {
                    $attrs .= ' height="630"';
                }
                
                // Add lazy loading
                if (!preg_match('/loading=["\'][^"\']*["\']/i', $attrs)) {
                    $attrs .= ' loading="lazy"';
                }
                
                return "<img{$attrs}>";
            },
            $content
        );
    }
    
    private function addHeaders($response)
    {
        // Cache headers (1 year for images, 1 hour for HTML)
        $response->headers->set('Cache-Control', 'public, max-age=3600');
        
        // HSTS header
        $response->headers->set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
        
        // Security headers
        $response->headers->set('X-Content-Type-Options', 'nosniff');
        $response->headers->set('X-Frame-Options', 'SAMEORIGIN');
        $response->headers->set('Referrer-Policy', 'strict-origin-when-cross-origin');
        
        return $response;
    }
}