<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class CacheControlMiddleware
{
    public function handle(Request $request, Closure $next)
    {
        $response = $next($request);
        
        // Cache static assets for 1 year
        if ($request->is('*.css') || $request->is('*.js') || $request->is('*.jpg') || $request->is('*.png') || $request->is('*.webp')) {
            $response->header('Cache-Control', 'public, max-age=31536000, immutable');
        }
        // Cache HTML pages for 1 hour
        elseif ($this->isHtmlResponse($response)) {
            $response->header('Cache-Control', 'public, max-age=3600');
        }
        
        return $response;
    }
    
    private function isHtmlResponse($response)
{
    $contentType = $response->headers->get('Content-Type');
    
    // Debug: Log the Content-Type
    \Log::info('SeoMiddleware Content-Type: ' . ($contentType ?? 'NULL'));
    
    // Check if it's HTML (including with charset or other parameters)
    if (!$contentType) {
        // If no Content-Type header, check the content
        $content = $response->getContent();
        $isHtml = str_contains($content, '<!DOCTYPE') || 
                  str_contains($content, '<html') || 
                  str_contains($content, '<head>');
        
        \Log::info('SeoMiddleware No Content-Type, checking content. Is HTML? ' . ($isHtml ? 'YES' : 'NO'));
        return $isHtml;
    }
    
    $contentType = strtolower($contentType);
    $isHtml = str_contains($contentType, 'text/html') || 
              str_contains($contentType, 'text/plain');
    
    \Log::info('SeoMiddleware Is HTML based on Content-Type? ' . ($isHtml ? 'YES' : 'NO'));
    return $isHtml;
}
}