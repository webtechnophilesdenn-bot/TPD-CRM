<?php

namespace App\Http\Controllers;

use App\Models\CaseStudy;
use Illuminate\Http\Request;

class CaseStudyController extends Controller
{
    public function index()
    {
        $caseStudiesData = CaseStudy::with(['categories', 'technologies', 'timeline', 'metrics'])
            ->published()
            ->orderBy('display_order')
            ->orderBy('created_at', 'desc')
            ->get()
            ->map(function($cs) {
                return [
                    'id' => $cs->id,
                    'title' => $cs->title,
                    'description' => $cs->description,
                    'categories' => $cs->categories->pluck('slug')->toArray(),
                    'image' => asset('storage/' . $cs->image),
                    'searchKeywords' => $cs->search_keywords ?? '',
                    'challenge' => $cs->challenge ?? 'This project presented unique challenges.',
                    'solution' => $cs->solution ?? 'We applied best practices to solve the challenges.',
                    'technologies' => $cs->technologies->map(function($t) {
                        return ['name' => $t->name, 'icon' => $t->icon];
                    })->toArray(),
                    'timeline' => $cs->timeline->map(function($t) {
                        return ['date' => $t->date, 'title' => $t->title, 'description' => $t->description];
                    })->toArray(),
                    'results' => $cs->results ?? 'Delivered measurable improvements.',
                    'metrics' => $cs->metrics->map(function($m) {
                        return ['number' => $m->number, 'label' => $m->label];
                    })->toArray(),
                ];
            });

        return view('case-studies.index', compact('caseStudiesData'));
    }

    public function api()
    {
        $caseStudies = CaseStudy::with(['categories', 'technologies', 'timeline', 'metrics'])
            ->published()
            ->orderBy('display_order')
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($caseStudies);
    }
}
