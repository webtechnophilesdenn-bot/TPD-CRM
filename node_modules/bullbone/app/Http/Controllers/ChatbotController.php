<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class ChatbotController extends Controller
{
    public function chat(Request $request)
    {
        try {
            // Validate request
            $validated = $request->validate([
                'message' => 'required|string|max:1000',
                'history' => 'nullable|array'
            ]);

            $userMessage = $validated['message'];
            
            Log::info('Chatbot received message: ' . $userMessage);

            // Try OpenAI first, fallback if fails
            $apiKey = env('OPENAI_API_KEY');

            if ($apiKey && strlen($apiKey) > 20) {
                try {
                    $response = Http::timeout(15)
                        ->withHeaders([
                            'Authorization' => 'Bearer ' . $apiKey,
                            'Content-Type' => 'application/json',
                        ])
                        ->post('https://api.openai.com/v1/chat/completions', [
                            'model' => 'gpt-3.5-turbo',
                            'messages' => [
                                [
                                    'role' => 'system',
                                    'content' => 'You are a helpful AI assistant for Technophiles Den, a technology company. Keep responses concise (2-3 sentences) and friendly.'
                                ],
                                [
                                    'role' => 'user',
                                    'content' => $userMessage
                                ]
                            ],
                            'max_tokens' => 200,
                            'temperature' => 0.7,
                        ]);

                    if ($response->successful()) {
                        $data = $response->json();
                        $botResponse = $data['choices'][0]['message']['content'] ?? null;
                        
                        if ($botResponse) {
                            Log::info('OpenAI response: ' . $botResponse);
                            return response()->json([
                                'success' => true,
                                'response' => trim($botResponse)
                            ]);
                        }
                    }
                    
                    Log::warning('OpenAI API failed: ' . $response->status());
                } catch (\Exception $e) {
                    Log::warning('OpenAI exception: ' . $e->getMessage());
                }
            }

            // Fallback response
            $fallbackResponse = $this->getFallbackResponse($userMessage);
            Log::info('Using fallback response');
            
            return response()->json([
                'success' => true,
                'response' => $fallbackResponse
            ]);

        } catch (\Illuminate\Validation\ValidationException $e) {
            Log::error('Validation error: ' . json_encode($e->errors()));
            
            return response()->json([
                'success' => false,
                'response' => 'Please enter a valid message.',
                'error' => $e->errors()
            ], 422);
            
        } catch (\Exception $e) {
            Log::error('Chatbot Error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'response' => 'Thanks for your message! Our team will get back to you soon. ðŸ˜Š',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    private function getFallbackResponse(string $message): string
    {
        $lowerMessage = strtolower($message);

        $responses = [
            'hello|hi|hey|hola' => "Hello! ðŸ‘‹ Welcome to Technophiles Den! We're here to help transform your tech vision into reality. What can I assist you with today?",
            
            'expert|talk|consultation|consult' => "ðŸ‘¨â€ðŸ’¼ Excellent! Our expert team specializes in:\n\nâ€¢ Cloud Architecture (AWS/Azure/GCP)\nâ€¢ AI & Machine Learning Solutions\nâ€¢ Full-Stack Development\nâ€¢ Cybersecurity & Infrastructure\n\nWould you like to schedule a free consultation?",
            
            'solution|service|offer' => "ðŸš€ We offer comprehensive tech solutions:\n\nâ€¢ Cloud Platforms & Migration\nâ€¢ AI/ML Integration\nâ€¢ Custom Software Development\nâ€¢ Enterprise Applications\nâ€¢ DevOps & Automation\nâ€¢ Cybersecurity Services\n\nWhich area interests you most?",
            
            'case|study|portfolio|project' => "ðŸ“Š Our success stories include:\n\nâ€¢ E-commerce platform scaling (300% traffic growth)\nâ€¢ AI-powered chatbot (70% support automation)\nâ€¢ Cloud migration project (40% cost reduction)\nâ€¢ HRMS system for 500+ employees\n\nWant details on any specific case study?",
            
            'start|begin|get started|onboard' => "âœ¨ Excited to start your journey with us!\n\nHere's how it works:\n1. Tell us about your project vision\n2. Schedule a free consultation\n3. Receive a customized proposal\n4. Launch & build together!\n\nWhat kind of project are you planning?",
            
            'price|cost|budget|pricing' => "ðŸ’° Our pricing is customized based on your specific needs:\n\nâ€¢ Project scope & complexity\nâ€¢ Timeline requirements\nâ€¢ Technology stack\nâ€¢ Ongoing support needs\n\nLet's discuss your project to provide accurate pricing. What's your budget range?",
            
            'ai|ml|machine learning|artificial intelligence' => "ðŸ¤– AI/ML is our specialty! We build:\n\nâ€¢ Custom AI models\nâ€¢ Chatbots & virtual assistants\nâ€¢ Predictive analytics systems\nâ€¢ Computer vision solutions\nâ€¢ NLP applications\n\nWhat AI solution are you considering?",
            
            'cloud|aws|azure|gcp' => "â˜ï¸ We're certified cloud experts! Our services:\n\nâ€¢ Cloud migration strategies\nâ€¢ Infrastructure optimization\nâ€¢ Auto-scaling solutions\nâ€¢ Cost optimization\nâ€¢ Security & compliance\n\nWhich cloud platform interests you?",
        ];

        foreach ($responses as $pattern => $response) {
            $keywords = explode('|', $pattern);
            foreach ($keywords as $keyword) {
                if (str_contains($lowerMessage, $keyword)) {
                    return $response;
                }
            }
        }

        return "Thanks for reaching out! ðŸ’¡\n\nI can help you with:\nâ€¢ Our tech solutions & services\nâ€¢ Technical consultation\nâ€¢ Project planning & pricing\nâ€¢ Case studies & portfolio\n\nWhat would you like to know more about?";
    }
}
