<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\CaseStudy;
use App\Models\CaseStudyCategory;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class CaseStudyController extends Controller
{
    public function index()
    {
        $caseStudies = CaseStudy::with('categories')
            ->orderBy('display_order')
            ->orderBy('created_at', 'desc')
            ->paginate(15);

        return view('admin.case-studies.index', compact('caseStudies'));
    }

    public function create()
    {
        $categories = CaseStudyCategory::orderBy('display_order')->get();
        return view('admin.case-studies.create', compact('categories'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'description' => 'required|string',
            'image' => 'required|image|mimes:jpeg,png,jpg,webp|max:2048',
            'status' => 'required|in:draft,published',
            'categories' => 'required|array|min:1',
            'categories.*' => 'exists:case_study_categories,id',
            'search_keywords' => 'nullable|string',
            'challenge' => 'nullable|string',
            'solution' => 'nullable|string',
            'results' => 'nullable|string',
            'project_date' => 'nullable|string|max:50',
            'is_featured' => 'boolean',
            'display_order' => 'nullable|integer',
            'technologies' => 'nullable|array',
            'technologies.*.name' => 'required_with:technologies|string|max:100',
            'technologies.*.icon' => 'required_with:technologies|string|max:100',
            'timeline' => 'nullable|array',
            'timeline.*.date' => 'required_with:timeline|string|max:50',
            'timeline.*.title' => 'required_with:timeline|string|max:150',
            'timeline.*.description' => 'required_with:timeline|string',
            'metrics' => 'nullable|array',
            'metrics.*.number' => 'required_with:metrics|string|max:50',
            'metrics.*.label' => 'required_with:metrics|string|max:100',
        ]);

        // Handle image upload
        $imagePath = $request->file('image')->store('case-studies', 'public');

        // Create case study
        $caseStudy = CaseStudy::create([
            'title' => $validated['title'],
            'description' => $validated['description'],
            'image' => $imagePath,
            'search_keywords' => $validated['search_keywords'] ?? null,
            'challenge' => $validated['challenge'] ?? null,
            'solution' => $validated['solution'] ?? null,
            'results' => $validated['results'] ?? null,
            'project_date' => $validated['project_date'] ?? null,
            'status' => $validated['status'],
            'is_featured' => $request->has('is_featured'),
            'display_order' => $validated['display_order'] ?? 0,
        ]);

        // Attach categories
        $caseStudy->categories()->attach($validated['categories']);

        // Add technologies
        if (!empty($validated['technologies'])) {
            foreach ($validated['technologies'] as $index => $tech) {
                $caseStudy->technologies()->create([
                    'name' => $tech['name'],
                    'icon' => $tech['icon'],
                    'display_order' => $index,
                ]);
            }
        }

        // Add timeline
        if (!empty($validated['timeline'])) {
            foreach ($validated['timeline'] as $index => $item) {
                $caseStudy->timeline()->create([
                    'date' => $item['date'],
                    'title' => $item['title'],
                    'description' => $item['description'],
                    'display_order' => $index,
                ]);
            }
        }

        // Add metrics
        if (!empty($validated['metrics'])) {
            foreach ($validated['metrics'] as $index => $metric) {
                $caseStudy->metrics()->create([
                    'number' => $metric['number'],
                    'label' => $metric['label'],
                    'display_order' => $index,
                ]);
            }
        }

        return redirect()->route('admin.case-studies.index')
            ->with('success', 'Case study created successfully!');
    }

    public function edit(CaseStudy $caseStudy)
    {
        $caseStudy->load(['categories', 'technologies', 'timeline', 'metrics']);
        $categories = CaseStudyCategory::orderBy('display_order')->get();
        return view('admin.case-studies.edit', compact('caseStudy', 'categories'));
    }

    public function update(Request $request, CaseStudy $caseStudy)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'description' => 'required|string',
            'image' => 'nullable|image|mimes:jpeg,png,jpg,webp|max:2048',
            'status' => 'required|in:draft,published',
            'categories' => 'required|array|min:1',
            'categories.*' => 'exists:case_study_categories,id',
            'search_keywords' => 'nullable|string',
            'challenge' => 'nullable|string',
            'solution' => 'nullable|string',
            'results' => 'nullable|string',
            'project_date' => 'nullable|string|max:50',
            'is_featured' => 'boolean',
            'display_order' => 'nullable|integer',
            'technologies' => 'nullable|array',
            'technologies.*.name' => 'required_with:technologies|string|max:100',
            'technologies.*.icon' => 'required_with:technologies|string|max:100',
            'timeline' => 'nullable|array',
            'timeline.*.date' => 'required_with:timeline|string|max:50',
            'timeline.*.title' => 'required_with:timeline|string|max:150',
            'timeline.*.description' => 'required_with:timeline|string',
            'metrics' => 'nullable|array',
            'metrics.*.number' => 'required_with:metrics|string|max:50',
            'metrics.*.label' => 'required_with:metrics|string|max:100',
        ]);

        // Handle image upload
        if ($request->hasFile('image')) {
            // Delete old image
            if ($caseStudy->image) {
                Storage::disk('public')->delete($caseStudy->image);
            }
            $imagePath = $request->file('image')->store('case-studies', 'public');
            $caseStudy->image = $imagePath;
        }

        // Update case study
        $caseStudy->update([
            'title' => $validated['title'],
            'description' => $validated['description'],
            'search_keywords' => $validated['search_keywords'] ?? null,
            'challenge' => $validated['challenge'] ?? null,
            'solution' => $validated['solution'] ?? null,
            'results' => $validated['results'] ?? null,
            'project_date' => $validated['project_date'] ?? null,
            'status' => $validated['status'],
            'is_featured' => $request->has('is_featured'),
            'display_order' => $validated['display_order'] ?? 0,
        ]);

        // Sync categories
        $caseStudy->categories()->sync($validated['categories']);

        // Update technologies
        $caseStudy->technologies()->delete();
        if (!empty($validated['technologies'])) {
            foreach ($validated['technologies'] as $index => $tech) {
                $caseStudy->technologies()->create([
                    'name' => $tech['name'],
                    'icon' => $tech['icon'],
                    'display_order' => $index,
                ]);
            }
        }

        // Update timeline
        $caseStudy->timeline()->delete();
        if (!empty($validated['timeline'])) {
            foreach ($validated['timeline'] as $index => $item) {
                $caseStudy->timeline()->create([
                    'date' => $item['date'],
                    'title' => $item['title'],
                    'description' => $item['description'],
                    'display_order' => $index,
                ]);
            }
        }

        // Update metrics
        $caseStudy->metrics()->delete();
        if (!empty($validated['metrics'])) {
            foreach ($validated['metrics'] as $index => $metric) {
                $caseStudy->metrics()->create([
                    'number' => $metric['number'],
                    'label' => $metric['label'],
                    'display_order' => $index,
                ]);
            }
        }

        return redirect()->route('admin.case-studies.index')
            ->with('success', 'Case study updated successfully!');
    }

    public function destroy(CaseStudy $caseStudy)
    {
        // Delete image
        if ($caseStudy->image) {
            Storage::disk('public')->delete($caseStudy->image);
        }

        $caseStudy->delete();

        return redirect()->route('admin.case-studies.index')
            ->with('success', 'Case study deleted successfully!');
    }
}
