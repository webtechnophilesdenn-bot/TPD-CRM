<?php

namespace App\Services;

use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\URL;
use Illuminate\Support\Str;

class SeoService
{
    /**
     * Generate complete meta tags array
     */
    public function generateMetaTags($title = null, $description = null, $image = null, $type = 'website')
    {
        $defaults = [
            'title' => $title ? $title . ' | ' . config('app.name') : config('app.name'),
            'description' => $description ?: 'Technology blog covering latest gadgets, software reviews, and tech tips',
            'image' => $image ?: asset('images/og-default.jpg'),
            'url' => url()->current(),
            'type' => $type,
            'site_name' => config('app.name'),
            'locale' => 'en_US',
            'twitter_handle' => '@technophilesden',
        ];

        return $defaults;
    }

    /**
     * Generate schema.org JSON-LD markup
     */
    public function generateSchema($type, $data)
    {
        switch ($type) {
            case 'article':
                return $this->articleSchema($data);
            case 'website':
                return $this->websiteSchema($data);
            case 'breadcrumb':
                return $this->breadcrumbSchema($data);
            default:
                return $this->websiteSchema($data);
        }
    }

    /**
     * Article schema for blog posts
     */
    protected function articleSchema($article)
    {
        return [
            '@context' => 'https://schema.org',
            '@type' => 'Article',
            'headline' => $article['title'] ?? '',
            'description' => $article['description'] ?? '',
            'image' => $article['image'] ?? asset('images/og-default.jpg'),
            'datePublished' => $article['published_at'] ?? now()->toIso8601String(),
            'dateModified' => $article['updated_at'] ?? now()->toIso8601String(),
            'author' => [
                '@type' => 'Person',
                'name' => $article['author']['name'] ?? 'Admin',
                'url' => $article['author']['url'] ?? url('/'),
            ],
            'publisher' => [
                '@type' => 'Organization',
                'name' => config('app.name'),
                'logo' => [
                    '@type' => 'ImageObject',
                    'url' => asset('images/logo.png'),
                ],
            ],
            'mainEntityOfPage' => [
                '@type' => 'WebPage',
                '@id' => url()->current(),
            ],
        ];
    }

    /**
     * Website schema for homepage
     */
    protected function websiteSchema($data)
    {
        return [
            '@context' => 'https://schema.org',
            '@type' => 'WebSite',
            'name' => config('app.name'),
            'url' => config('app.url'),
            'description' => $data['description'] ?? 'Technology blog',
            'potentialAction' => [
                '@type' => 'SearchAction',
                'target' => config('app.url') . '/search?q={search_term_string}',
                'query-input' => 'required name=search_term_string',
            ],
        ];
    }

    /**
     * Breadcrumb schema for navigation
     */
    protected function breadcrumbSchema($items)
    {
        $breadcrumbList = [
            '@context' => 'https://schema.org',
            '@type' => 'BreadcrumbList',
            'itemListElement' => [],
        ];

        $position = 1;
        foreach ($items as $name => $url) {
            $breadcrumbList['itemListElement'][] = [
                '@type' => 'ListItem',
                'position' => $position,
                'name' => $name,
                'item' => $url,
            ];
            $position++;
        }

        return $breadcrumbList;
    }

    /**
     * Generate sitemap URLs
     */
    public function generateSitemapUrls()
    {
        $urls = [
            [
                'url' => url('/'),
                'last_modified' => now()->toAtomString(),
                'change_frequency' => 'daily',
                'priority' => '1.0',
            ],
            [
                'url' => url('/about'),
                'last_modified' => now()->toAtomString(),
                'change_frequency' => 'monthly',
                'priority' => '0.8',
            ],
            [
                'url' => url('/contact'),
                'last_modified' => now()->toAtomString(),
                'change_frequency' => 'monthly',
                'priority' => '0.8',
            ],
            [
                'url' => url('/blog'),
                'last_modified' => now()->toAtomString(),
                'change_frequency' => 'daily',
                'priority' => '0.9',
            ],
        ];

        // Add dynamic content if you have Post model
        if (class_exists('\App\Models\Post')) {
            $posts = \App\Models\Post::where('status', 'published')->get();
            
            foreach ($posts as $post) {
                $urls[] = [
                    'url' => url('/blog/' . $post->slug),
                    'last_modified' => $post->updated_at->toAtomString(),
                    'change_frequency' => 'weekly',
                    'priority' => '0.7',
                ];
            }
        }

        return $urls;
    }

    /**
     * Generate robots.txt content
     */
    public function generateRobotsTxt()
    {
        $content = "User-agent: *\n";
        $content .= "Allow: /\n";
        $content .= "Disallow: /admin/\n";
        $content .= "Disallow: /dashboard/\n";
        $content .= "Disallow: /login\n";
        $content .= "Disallow: /register\n\n";
        $content .= "Sitemap: " . url('/sitemap.xml') . "\n";
        
        return $content;
    }

    /**
     * Generate Open Graph tags HTML
     */
    public function generateOpenGraphHtml($meta)
    {
        $html = '';
        
        $tags = [
            'og:title' => $meta['title'],
            'og:description' => Str::limit($meta['description'], 160),
            'og:image' => $meta['image'],
            'og:url' => $meta['url'],
            'og:type' => $meta['type'],
            'og:site_name' => $meta['site_name'],
            'og:locale' => $meta['locale'],
        ];

        foreach ($tags as $property => $content) {
            if (!empty($content)) {
                $html .= '<meta property="' . e($property) . '" content="' . e($content) . '">' . "\n";
            }
        }

        return $html;
    }

    /**
     * Generate Twitter Card tags HTML
     */
    public function generateTwitterCardHtml($meta)
    {
        $html = '';
        
        $tags = [
            'twitter:card' => 'summary_large_image',
            'twitter:title' => $meta['title'],
            'twitter:description' => Str::limit($meta['description'], 160),
            'twitter:image' => $meta['image'],
            'twitter:site' => $meta['twitter_handle'],
            'twitter:creator' => $meta['twitter_handle'],
        ];

        foreach ($tags as $name => $content) {
            if (!empty($content)) {
                $html .= '<meta name="' . e($name) . '" content="' . e($content) . '">' . "\n";
            }
        }

        return $html;
    }

    /**
     * Generate canonical tag HTML
     */
    public function generateCanonicalHtml($url = null)
    {
        $url = $url ?: url()->current();
        return '<link rel="canonical" href="' . e($url) . '">';
    }

    /**
     * Generate JSON-LD schema HTML
     */
    public function generateSchemaHtml($schemaData)
    {
        return '<script type="application/ld+json">' . 
               json_encode($schemaData, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT) . 
               '</script>';
    }

    /**
     * Get SEO-friendly slug
     */
    public function generateSlug($title)
    {
        return Str::slug($title, '-', 'en');
    }
}